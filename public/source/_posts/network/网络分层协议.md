---
title: 计算机网络-网络分层协议
categories: network
tags:
  - network
keywords: 'network,计算机网络'
abbrlink: 3ac3ca44
date: 2022-02-20 12:00:00
---




相关参考：

- [cs-wiki](https://veal98.gitee.io/cs-wiki/#/)
- [30张图解： TCP 重传、滑动窗口、流量控制、拥塞控制](https://www.cnblogs.com/xiaolincoding/p/12732052.html)
- [一篇文章带你熟悉 TCP/IP 协议（网络协议篇二）](https://juejin.cn/post/6844903510509633550)
- [CS-Notes - 计算机网络](http://www.cyc2018.xyz/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E7%9B%AE%E5%BD%95.html#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5)



## 网络分层协议（七层、五层、四层）

**OSI七层模型**

OSI七层协议模型主要是：应用层（Application）、表示层（Presentation）、会话层（Session）、传输层（Transport）、网络层（Network）、数据链路层（Data Link）、物理层（Physical）。

**TCP/IP四层模型**

TCP/IP是一个四层的体系结构，主要包括：应用层、运输层、网际层和网络接口层。

**五层体系结构**

五层体系结构包括：应用层、运输层、网络层、数据链路层和物理层。五层协议只是OSI和TCP/IP的综合，实际应用还是TCP/IP的四层结构。为了方便可以把下两层称为网络接口层。

![](https://blog.lichenghao.cn/upload/2022/07/195318.png)



各层的作用说明

1. 物理层：主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。它的主要作用是传输比特流（就是由1、0转化为电流强弱来进行传输,到达目的地后在转化为1、0，也就是我们常说的数模转换与模数转换）。这一层的数据叫做比特。

2. 数据链路层：定义了如何让格式化数据以进行传输，以及如何让控制对物理介质的访问。这一层通常还提供错误检测和纠正，以确保数据的可靠传输。

3. 网络层：在位于不同地理位置的网络中的两个主机系统之间提供连接和路径选择。Internet的发展使得从世界各站点访问信息的用户数大大增加，而网络层正是管理这种连接的层。

4. 运输层：定义了一些传输数据的协议和端口号。

   运输层主要使用以下两种协议：

   (1) 传输控制协议TCP(Transmission Control Protocol)：面向连接的，数据传输的单位是报文段，能够提供可靠的交付。

   (2) 用户数据包协议UDP(User Datagram Protocol)：无连接的，数据传输的单位是用户数据报，不保证提供可靠的交付，只能提供“尽最大努力交付”。

5. 会话层：通过运输层（端口号：传输端口与接收端口）建立数据传输的通路。主要在你的系统之间发起会话或者接受会话请求（设备之间需要互相认识可以是IP也可以是MAC或者是主机名）

6. 表示层：可确保一个系统的应用层所发送的信息可以被另一个系统的应用层读取。例如，PC程序与另一台计算机进行通信，其中一台计算机使用扩展二一十进制交换码（EBCDIC），而另一台则使用美国信息交换标准码（ASCII）来表示相同的字符。如有必要，表示层会通过使用一种通格式来实现多种数据格式之间的转换。

7. 应用层：是最靠近用户的OSI层。这一层为用户的应用程序（例如电子邮件、文件传输和终端仿真）提供网络服务。在因特网中的应用层协议很多，如支持万维网应用的HTTP协议，支持电子邮件的SMTP协议，支持文件传送的FTP协议等等



## PC 间通信？



分层协议参考模型是为了更方便的从宏观角度去理解网络数据的传输过程，那么大千世界之间两台PC到底是如何进行通信的呢？那么接下来以五层协议为参考，看下他们之间到底是怎样进行"交流"的。

再回顾下网络五层模型：

- 应用层

- 传输层

- 网络层

- 数据链路层

- 物理层



### 物理层

也就是最下面的一层，两台设备要想进行沟通，肯定需要某些介质作为媒介。就比如声音在真空是不能传播，需要传播介质一样。网络的传输介质可以分成两大类：

- 有线传播介质

有线传输介质是指在两个通信设备之间实现的物理连接部分，它能将信号从一方传输到另一方，有线传输介质主要有双绞线、同轴电缆（双绞线和同轴电缆传输电信号）和光纤（光纤传输光信号）

![](https://blog.lichenghao.cn/upload/2022/07/3cce767c1f8b11ec999e0a80ff2603de.jpg ':size=50%')

- 无线传播介质

无线传输介质指我们周围的自由空间。我们利用无线电波在自由空间的传播可以实现多种无线通信。在自由空间传输的电磁波根据频谱可将其分为无线电波、微波、红外线、激光等，信息被加载在电磁波上进行传输

物理层通过这些传输介质，将PC之间的数据比特流进行相互传递就完成了物理层的任务。

### 数据链路层

用线把两台计算机连起来，然后进行传输数据，看似很不错，其实单单这样传输还是存在这许多的问题，比如：

- 虽然是传递比特流，但是传递是没有规则的，俗话说没有规矩不成方圆，这胡乱的传递怎么处理？
- 我这边是高级的线缆，你那边是比较低级的线缆，我传输的贼快，你能接受的了吗？
- ......

其实还有很多问题，问了解决诸多的问题，的需要把数据"归置归置"，然后在传递出去，数据链路层就完成了这个“归置”工作，即他将网络层的 IP 数据包**封装成帧**，然后再让物理层可靠的传输出去。

**如何封装成帧？**

封装成帧就是把上层传递过来的数据进行包装下，在数据包的开头加个“帧首”，数据包的结尾加个“帧尾”，这样就是一个帧了。接收端就这样一帧一帧的去接收数据，不会乱套了。

**把帧发给谁？**

虽然我们把数据整理好了，但是又有个新问题，网线不可能就连接两台计算机把，肯定是连接无数个计算机，那么我们的帧到底发给哪个计算机？为了定位唯一的一台计算机就给计算机颁发个“身份证”，也就是我们经常说的MAC地址，长度为 6 字节（48 位），用于唯一标识网络适配器（网卡）。计算机之间的数据传送，就是通过 MAC 地址来唯一寻找、传送的。**一台主机拥有多少个网络适配器就有多少个 MAC 地址**。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。



### 网络层

两台计算机通信，中间可能会经过很多其他的设备，也就是说会经过多个数据链路，网络层就是告诉计算机你要按照那条链路走，才能把数据准确送达。网络层将传输层的数据进行打包进行传送。

?> **IP协议**

TCP/IP体系中该层通常使用IP协议，它提供无连接，不可靠，尽力交付的传送服务。

- 无连接

发送端随时随地都可以发送数据，接收端也不知道何时开始准备接收数据。发送端想发就发，想停就停，而且数据传送过程丢失也不知道，也不管。

- 不可靠

在数据传输的过程中，数据可能丢失，重复，延迟等，IP协议不做任何的处理，也不做任何的提示。但是我们都收到相关的提示，这个提示是由路由器发送的`ICMP`通知的，还有可能需要更上层去处理这些问题。

- 尽力交付

不同的网络情况，需要对数据包进行分段和封装然后在传输。

?> **ARP地址解析协议**

上面说了数据链路层需要知道MAC地址才能知道把数据投递给谁，那么这个MAC地址就是在网络层通过ARP协议指定的。**ARP（Address Resolution Protocol ）协议就可以实现由 IP 地址得到 MAC 地址。**

**ARP如何用IP得到MAC地址？**

每个主机都一个`ARP表`,它记录着主机的IP地址和MAC地址的对应关系。那么是怎样的处理过程？

如果主机A想要发送数据给主机B，主机A会先检查下自己的ARP缓存，看看有没有主机B的IP和MAC地址的映射关系，如果没有的话就会发送一条ARP请求消息，如果这个时候主机B接收到消息后，校验IP是自己，那就把主机A的IP和MAC缓存到自己的ARP缓存中，同时会发送一个ARP应答，把自己的MAC地址给补充上去。主机A接收到应答之后，把主机B的IP和MAC映射添加到自己的ARP缓存中。这个时候主机A就知道谁是主机B了，就可以给他发数据了。（这只是简单的过程~~）



window下查看arp表

```bash
C:\Users\chenghaoli>arp -a

接口: 192.168.122.3 --- 0x8
  Internet 地址         物理地址              类型
  192.168.122.100       00-0c-29-bc-4c-3a     动态
  192.168.122.255       ff-ff-ff-ff-ff-ff     静态
  224.0.0.22          01-00-5e-00-00-16     静态
  224.0.0.251         01-00-5e-00-00-fb     静态

接口: 192.168.4.56 --- 0xd
  Internet 地址         物理地址              类型
  192.168.4.1           68-91-d0-d1-09-31     动态
  192.168.4.20          44-6a-2e-13-63-20     动态
```

linux 下查看arp表

```bash
[root@localhost ~]# arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.122.3            ether   00:50:56:c0:00:08   C                     ens33
gateway                  ether   00:50:56:f9:40:7a   C                     ens33
```



类型是静态的一般会一直存在，动态的话如果在一定时间内不使用就会被删除，以提高arp表的响应效率。



>  其实不但有根据IP找MAC的协议，还有根据MAC找IP的协议，也就是`RARP协议`



### 传输层

通过上面几层的处理我们已经可以将数据准确的传送给目标计算机，那么问题来了，目标计算机上跑着很多程序，我们要把数据给哪个程序？为了解决这个问题，就有了`端口号(port)`，每个服务运行会用唯一的一个端口号来标识自己（不同的程序可能跑多个服务，也就会用多个端口号），这样的话通过 IP+端口就能将数据准确的发给目标计算的指定程序了。

传输层两个协议 `TCP` 和 `UDP` 可以说是很重要了，并且 TCP 可能是重中之重了。网络攻击大多数都在这层，而且面试也是高频，尤其是懂不懂的都会问： "TCP三次握手"知道吗？

**TCP** 传输控制协议（Transmission Control Protocol）

传输控制协议，面向连接的，提供可靠的交付，可靠是因为在传输数据前需要建立连接，也就是三次握手。除此之外还可以流量控制，拥塞控制，提供双全工通信，面向字节流，一对一通信等。

**UDP**  用户数据报协议（User Datagram Protocol）

用户传递数据之前不需要建立连接，尽最大可能交付，面向报文，支持一对一，一对多，多对一，多对多等，最形象的例子就是写信，我信件邮递出去之后，我也不知道你收到没收到。那这样的协议就没啥用了吗？不，在某些情况下 UDP 确是一种最有效的工作方式（一般用于即时通信），比如： 微信视频 、直播等等

### 应用层

应用层是最接近我们的了，应用层的协议我们每天都在用，比如网页的 HTML，听歌的 MP4，发邮件的 SMTP,POP3，文件传输协议 FTP，域名解析 DNS，上网必备的HTTP等等，这一层交互的数据我们称之为`报文`。

上面的几层我们说过ARP 和 RARP 协议，通过 IP 找 MAC 或者通过 MAC 找 IP，我们在上网的时候通过域名访问网站，例如通过谷歌查找资料都是在浏览器地址输入 www.google.com 然后在继续... 那么计算机怎么知道域名对应这哪个 IP 地址？这就需要 DNS 域名解析协议了。

域名其实就是一棵树结构：从上到下分别为根，顶级域名，二级域名，三级域名......

例如：`blog.lichenghao.com`  .com 就是顶级域名；.lichenghao 就是二级域名； blog 就是三级域名

那么 DNS 是怎么知道域名和 IP 的对应关系的？解析方式有两种，`递归查询`和`迭代查询`

域名解析示意图：

![](https://blog.lichenghao.cn/upload/2022/07/bed80db8232811ecb4000a80ff2603de.png)



大致过程：

1. 浏览器会有 DNS 缓存，那么浏览器首先查自己的缓存
2. 浏览发现自己的缓存中没有，那么就要递归检索操作系统的 DNS 缓存，比如系统的 HOST 文件
3. 如果操作系统的 DNS 缓存也没有那么就要向更上层的服务器进行迭代查找
4. - 本地域名服务器向根域名服务器请求，得到com的顶级域名服务器的地址
   - 本地域名服务器向com的顶级域名服务器发送请求，得到权限域名服务器的地址
   - 本地域名服务器向权限域名服务器发情请求，得到最终的 IP 地址
5. 本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址缓存起来
6. 操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来
7. 这样话，最终得到了域名对应的 IP 地址



?>（1）递归查询：本机向本地域名服务器发出一次查询请求，就静待最终的结果。如果本地域名服务器无法解析，自己会以DNS客户机的身份向其它域名服务器查询，直到得到最终的IP地址告诉本机 
（2）迭代查询：本地域名服务器向根域名服务器查询，根域名服务器告诉它下一步到哪里去查询，然后它再去查，每次它都是以客户机的身份去各个服务器查询。







