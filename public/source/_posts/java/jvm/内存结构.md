---
title: JVM-å†…å­˜ç»“æ„
categories: jvm
tags:
  - java
  - jvm
keywords: 'java,jvm'
cover: https://blog.lichenghao.cn/upload/2022/07/724CCDD7-jvm.png
abbrlink: 215fcc6b
date: 2022-05-15 13:50:00
---


## ç¨‹åºè®¡æ•°å™¨

Program Counter Register.

ç¨‹åºè®¡æ•°å™¨è®°å½•ä¸‹ä¸€æ¡ JVMæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ã€‚ï¼ˆç¨‹åºè®¡æ•°å™¨é€šè¿‡CPUä¸­çš„å¯„å­˜å™¨å®ç°ï¼‰ã€‚

> æˆ‘ä»¬çš„æºä»£ç ç»è¿‡ç¼–è¯‘å˜æˆ.class å­—èŠ‚ç æ–‡ä»¶ï¼ŒJVMçš„è§£é‡Šå™¨å°†å­—èŠ‚ç æ–‡ä»¶å˜æˆæœºå™¨ç äº¤ç»™æˆ‘ä»¬çš„CPUå»æ‰§è¡Œã€‚ç¨‹åºè®¡æ•°å™¨çš„è®°å½•ä¸‹æ¬¡è¦æ‰§è¡Œçš„ JVM æŒ‡ä»¤ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹è¢«é˜»å¡äº†ï¼Œå½“è¢«å”¤é†’çš„æ—¶å€™çš„çŸ¥é“ç»§ç»­æ‰§è¡Œä¸Šæ¬¡çš„ä»»åŠ¡ã€‚

ç‰¹ç‚¹ï¼š

- ç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰ï¼Œæ¯ä¸ªç°æœ‰éƒ½æœ‰è‡ªå·±çš„è®¡æ•°å™¨ã€‚
- å®ƒä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºï¼Œå› ä¸ºå®ƒéšç€çº¿ç¨‹å‡ºç”Ÿï¼Œéšç€çº¿ç¨‹æ­»äº¡ã€‚



## è™šæ‹Ÿæœºæ ˆ

### å®šä¹‰

Java Virtual Machine Stacks.

- çº¿ç¨‹è¿è¡Œæ—¶éœ€è¦çš„å†…å­˜ç©ºé—´,ç§°ä¹‹ä¸ºè™šæ‹Ÿæœºæ ˆã€‚

- æ ˆå†…ç”±å¤šä¸ªæ ˆå¸§ç»„ï¼ˆFrameï¼‰æˆï¼›æ ˆå¸§ï¼šæ–¹æ³•è¿è¡Œæ—¶éœ€è¦çš„å†…å­˜ï¼ŒåŒ…æ‹¬å‚æ•°ï¼Œå±€éƒ¨å˜é‡ï¼Œè¿”å›åœ°å€ã€‚

- æ¯ä¸ªçº¿ç¨‹å¯èƒ½æœ‰å¤šä¸ªæ ˆå¸§ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ï¼Œå¯¹åº”è¿™æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•ã€‚



ç‰¹ç‚¹ï¼š

- åƒåœ¾å›æ”¶ä¸ä¼šæ¶‰åŠæ ˆå†…å­˜ï¼Œå› ä¸ºæ–¹æ³•æ‰§è¡Œå®Œæ¯•å°±ä¼šé”€æ¯ï¼Œå¯¹åº”çš„å†…å­˜å°±ä¼šé‡Šæ”¾ã€‚

### æ ˆå†…å­˜æº¢å‡º

äº§ç”Ÿæƒ…å†µï¼š

- æ ˆå¸§è¿‡å¤š*ï¼Œä¾‹å¦‚é€’å½’æ²¡æœ‰ç»“æŸæ¡ä»¶ã€‚
- æ ˆå¸§è¿‡å¤§ï¼Œç›´æ¥æ’‘çˆ†ä¸€ä¸ªæ ˆå¸§ï¼Œä¸å¤ªå®¹æ˜“å‡ºç°ã€‚



```java
/**
 * æ ˆå¸§è¿‡å¤šï¼Œæ ˆå†…å­˜æº¢å‡ºï¼ŒæŒ‡å®šæ ˆå¤§å°ï¼š-Xss160k
 */
public class Test03 {
    private static int count;

    public static void main(String[] args) {
        try {
            over();
        } catch (Throwable e) {
            e.printStackTrace();
            System.out.println(count);
        }
    }

    private static void over() {
        count++;
        over();
    }
}
```

ç»“æœï¼š

```java
java.lang.StackOverflowError
	at test.Test03.over(Test03.java:19)
  ....
  850
```



## æœ¬åœ°æ–¹æ³•æ ˆ

ç»™æœ¬åœ°æ–¹æ³•çš„è¿è¡Œæä¾›ç©ºé—´ï¼Œæœ¬åœ°æ–¹æ³•éƒ½ä¸€äº›åº•å±‚çš„ C æ–¹æ³•ï¼Œä¾‹å¦‚Object ä¸­çš„ clone æ–¹æ³•ã€‚



## å †

### å®šä¹‰

Heap

- é€šè¿‡ new å…³é”®å­—åˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šä½¿ç”¨å †å†…å­˜ã€‚
- ä»–æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œå †ä¸­çš„å¯¹è±¡éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚
- æ˜¯åƒåœ¾å›æ”¶â™»ï¸çš„ä¸»è¦åŒºåŸŸã€‚

### å †å†…å­˜æº¢å‡º

æŒç»­æ–°å»ºå¯¹è±¡ï¼Œå¹¶ä¸”è®©è¿™ä¸ªå¯¹è±¡æœ‰å¼•ç”¨ã€‚

```java
/**
 * å †å†…å­˜æº¢å‡ºï¼ŒæŒ‡å®šå †å¤§å°ï¼š-Xmx8m
 */
public class Test03 {
    private static int count;

    public static void main(String[] args) {
        List<String> list = new ArrayList<>();
        String h = "hello world";
        try {
            while (true) {
                list.add(h);
                h += h;
                count++;
            }
        } catch (Throwable e) {
            e.printStackTrace();
            System.out.println(count);
        }
    }
}
```

ç»“æœï¼š

```java
java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:3332)
	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)
	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:448)
	at java.lang.StringBuilder.append(StringBuilder.java:136)
	at test.Test03.main(Test03.java:18)
16
```



### å †å†…å­˜è¯Šæ–­å·¥å…·

{% tabs è¯Šæ–­å·¥å…· %}
<!-- tab jps -->
æŸ¥çœ‹å½“å‰ç³»ç»Ÿæœ‰å“ªäº› java è¿›ç¨‹ã€‚

```shell
[root@localhost ~]# jps
2388 Jps
2159 jar
```

<!-- endtab -->
<!-- tab jmap -->
æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µã€‚

```shell
[root@localhost ~]# jmap -heap 2159
Attaching to process ID 2159, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.322-b06

using thread-local object allocation.
Mark Sweep Compact GC

Heap Configuration:
   MinHeapFreeRatio         = 40
   MaxHeapFreeRatio         = 70
   MaxHeapSize              = 255852544 (244.0MB)
   NewSize                  = 5570560 (5.3125MB)
   MaxNewSize               = 85262336 (81.3125MB)
   OldSize                  = 11206656 (10.6875MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)

Heap Usage:
New Generation (Eden + 1 Survivor Space):
   capacity = 5046272 (4.8125MB)
   used     = 1188736 (1.1336669921875MB)
   free     = 3857536 (3.6788330078125MB)
   23.55671672077922% used
Eden Space:
   capacity = 4521984 (4.3125MB)
   used     = 1188736 (1.1336669921875MB)
   free     = 3333248 (3.1788330078125MB)
   26.287930253623188% used
From Space:
   capacity = 524288 (0.5MB)
   used     = 0 (0.0MB)
   free     = 524288 (0.5MB)
   0.0% used
To Space:
   capacity = 524288 (0.5MB)
   used     = 0 (0.0MB)
   free     = 524288 (0.5MB)
   0.0% used
tenured generation:
   capacity = 11206656 (10.6875MB)
   used     = 0 (0.0MB)
   free     = 11206656 (10.6875MB)
   0.0% used

1648 interned Strings occupying 106528 bytes.
```



<!-- endtab -->
<!-- tab jconsole -->
å›¾å½¢ç•Œé¢ï¼Œå¤šåŠŸèƒ½æ£€æµ‹å·¥å…·ï¼ŒæŒç»­ç›‘æµ‹ã€‚
<!-- endtab -->

<!-- tab jvisualvm -->
å›¾å½¢åŒ–ç•Œé¢ï¼Œéƒ½æ˜¯å’Œ jconsole ä¸€æ ·ï¼Œéƒ½æ˜¯ jdk é»˜è®¤æä¾›çš„ã€‚
<!-- endtab -->

{% endtabs %}

## æ–¹æ³•åŒº

### å®šä¹‰

å‚è€ƒå®˜æ–¹æ–‡æ¡£å¯¹æ–¹æ³•åŒºçš„å®šä¹‰ï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4

> The Java Virtual Machine has a *method area* that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the "text" segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods ([Â§2.9](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9)) used in class and instance initialization and interface initialization.The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.The following exceptional condition is associated with the method area:
>
> - If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an `OutOfMemoryError`.

å¤§æ¦‚æ„æ€ï¼šæ–¹æ³•åŒºæ˜¯çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œå­˜å‚¨è¿™å’Œç±»çš„ç»“æ„ç›¸å…³çš„ä¿¡æ¯åŒ…æ‹¬ï¼šç±»çš„æ„é€ æ–¹æ³•ã€æˆå‘˜æ–¹æ³•ã€å±æ€§ã€æ–¹æ³•ç›¸å…³çš„æ•°æ®ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ç­‰ã€‚

è™šæ‹Ÿæœºå¯åŠ¨ï¼Œæ–¹æ³•åŒºå°±ä¼šè¢«åˆå§‹åŒ–ã€‚æ–¹æ³•åŒºé€»è¾‘ä¸Šæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä¸åŒçš„ JVMå®ç°å¯èƒ½å­˜æ”¾åœ¨ä¸åŒçš„ä½ç½®ã€‚JDK1.7å®ç°å«æ°¸ä¹…ä»£ä½¿ç”¨å †å†…å­˜ï¼›JDK1.8åˆ™å˜æˆäº†å…ƒç©ºé—´ï¼Œä½¿ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœæ–¹æ³•åŒºç”³è¯·å†…å­˜ä¸è¶³çš„æ—¶å€™ä¹Ÿä¼š OOMã€‚



### è®©æ–¹æ³•åŒºå†…å­˜æº¢å‡º

```java
/**
 * JDK8,æ–¹æ³•åŒºå†…å­˜æº¢å‡ºï¼ŒæŒ‡å®šå…ƒç©ºé—´å¤§å°ï¼š-XX:MaxMetaspaceSize=8m
 */
public class Test03 extends ClassLoader {
    public static void main(String[] args) {
        int count = 0;
        try {
            Test03 test03 = new Test03();
            for (int i = 0; i < 100000; i++) {
                ClassWriter classWriter = new ClassWriter(0);
                // ç‰ˆæœ¬å·ï¼Œpublic,ç±»åï¼ŒåŒ…åï¼Œçˆ¶ç±»ï¼Œæ¥å£
                classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, "Class" + i, null, "java/lang/Object", null);
                byte[] codes = classWriter.toByteArray();
                // æ‰§è¡Œç±»åŠ è½½
                test03.defineClass("Class" + i, codes, 0, codes.length);
                count++;
            }
        } catch (Throwable e) {
            e.printStackTrace();
            System.out.println(count);
        }
    }
}
```



### è¿è¡Œæ—¶å¸¸é‡æ± 

é¦–å…ˆäº†è§£ä¸‹`å¸¸é‡æ± `ï¼Œæˆ‘ä»¬.java æ–‡ä»¶ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶.class åï¼Œé‡Œé¢ä¸»è¦åŒ…æ‹¬çš„ä¿¡æ¯æœ‰ï¼šç±»åŸºæœ¬ä¿¡æ¯ï¼Œå¸¸é‡æ± ï¼Œç±»æ–¹æ³•å®šä¹‰ç­‰ã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼šä¸€ä¸ªç®€å•çš„ hello world

```java
/**
 * Hello world!
 */
public class App {
    public static void main(String[] args) {
        System.out.println("Hello World!");
    }
}
```

åˆ©ç”¨ jdk çš„ javap å‘½ä»¤ç¿»è¯‘æˆæˆ‘ä»¬å·®ä¸å¤šå¯ä»¥è¯»æ‡‚çš„æ–‡ä»¶

```java
javap -v App 
// ç±»çš„åŸºæœ¬ä¿¡æ¯
Classfile /Users/lichenghao/workspace/mtest/target/classes/org/example/App.class
  Last modified 2022-2-21; size 537 bytes
  MD5 checksum 79421a0912f67fb9a843b4ae35fab173
  Compiled from "App.java"
public class org.example.App
  minor version: 0
  major version: 51
  flags: ACC_PUBLIC, ACC_SUPER
    
// å¸¸é‡æ± 
Constant pool:
   #1 = Methodref          #6.#20         // java/lang/Object."<init>":()V
   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String             #23            // Hello World!
   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #5 = Class              #26            // org/example/App
   #6 = Class              #27            // java/lang/Object
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lorg/example/App;
  #14 = Utf8               main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8               args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8               SourceFile
  #19 = Utf8               App.java
  #20 = NameAndType        #7:#8          // "<init>":()V
  #21 = Class              #28            // java/lang/System
  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;
  #23 = Utf8               Hello World!
  #24 = Class              #31            // java/io/PrintStream
  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V
  #26 = Utf8               org/example/App
  #27 = Utf8               java/lang/Object
  #28 = Utf8               java/lang/System
  #29 = Utf8               out
  #30 = Utf8               Ljava/io/PrintStream;
  #31 = Utf8               java/io/PrintStream
  #32 = Utf8               println
  #33 = Utf8               (Ljava/lang/String;)V
                            
// æ–¹æ³•å®šä¹‰
{
  public org.example.App();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 6: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/example/App;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         // è™šæ‹ŸæœºæŒ‡ä»¤,ä¾‹å¦‚åŠ è½½å¸¸é‡æ± ä¸­#2çš„ä¸œè¥¿
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3                  // String Hello World!
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 8: 0
        line 9: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  args   [Ljava/lang/String;
}
SourceFile: "App.java"
```

ç„¶åæˆ‘ä»¬è§£è¯»ä¸‹ main æ–¹æ³•ä¸­çš„è™šæ‹ŸæœºæŒ‡ä»¤ï¼š

ç¬¬ä¸€æ¡ï¼š`0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;`

> åé¢çš„`// Field java/lang/System.out:Ljava/io/PrintStream`æ˜¯ javap å‘½ä»¤å¸®æˆ‘å¡«ä¸Šäº†ï¼Œæ˜ç¡®çš„å‘Šè¯‰æˆ‘ä»¬äº†æœ€ç»ˆçš„ç»“æœæ˜¯ System.out.PrintStream

å…·ä½“çš„æŒ‡ä»¤æŸ¥å¸¸é‡è¡¨æ‰§è¡Œå¦‚ä¸‹ï¼š

{% mermaid %}
graph TB

classDef default fill:#6c6cff,stroke:#6c6cff,stroke-width:0px,fill-opacity:0.5;

2("0: getstatic #2")
2122("#2 = Fieldref #21.#22 ")
21("#21 = Class #28")
28("#28 = Utf8 java/lang/System")
22("#22 = NameAndType #29:#30 ")
29("#29 = Utf8 out")
30("#30 = Utf8 Ljava/io/PrintStream;")
res("Field java/lang/System.out:Ljava/io/PrintStream")

2--åŠ è½½#2å˜é‡-->2122
2122--#22-->22
2122--#21-->21--#28-->28

22--#29-->29
22--#30-->30

29---->res
30---->res
28---->res
{% endmermaid %}



ç¬¬äºŒæ¡ï¼š`3: ldc           #3                  // String Hello World!`

æ„æ€å°±æ˜¯åŠ è½½äº†ä¸€ä¸ªå¸¸é‡ï¼ŒHello World!

{% mermaid %}
graph TB

classDef default fill:#6c6cff,stroke:#6c6cff,stroke-width:0px,fill-opacity:0.5;

start("3: ldc #3")
3("#3 = String #23")
23("#23 = Utf8 Hello World!")
res("Hello World!")
start--#3-->3--#23-->23--->res
{% endmermaid %}



ç¬¬ä¸‰æ¡ï¼š`5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V`

å¯ä»¥çœ‹å‡ºè°ƒç”¨äº†æ–¹æ³•ï¼Œæ‰“å°å­—ç¬¦ä¸²ã€‚

{% mermaid %}
graph TB

classDef default fill:#6c6cff,stroke:#6c6cff,stroke-width:0px,fill-opacity:0.5;

start("5: invokevirtual #4")
4("#4 = Methodref  #24.#25")
24("#24 = Class              #31")
25("#25 = NameAndType        #32:#33")
32("#32 = Utf8               println")
33("#33 = Utf8               (Ljava/lang/String;)V")
res("Method java/io/PrintStream.println:(Ljava/lang/String;)V")

start--#4-->4
4--#24-->24
4--#25-->25
24--#32-->32
25--#33-->33

32---->res
33---->res
{% endmermaid %}



> æœ€ç»ˆç»è¿‡ä¸Šé¢çš„ä¸‰æ¡æŒ‡ä»¤ï¼Œå°±å¯ä»¥æ˜ç¡®çš„çŸ¥é“éœ€è¦åˆ°å“ªä¸ªç±»ä¸­ï¼Œä½¿ç”¨å“ªäº›å‚æ•°ï¼Œè°ƒç”¨å“ªäº›æ–¹æ³•ã€‚æ‰€ä»¥å¸¸é‡æ± å°±å¥½é‡è·¯æ ‡ä¸€æ ·ï¼ŒæŒ‰ç…§ç¬¦å·ä¸€ä¸ªä¸€ä¸ªçš„å»æ‰¾å°±è¡Œäº†ã€‚



**ç»è¿‡ä¸Šé¢çš„æ¼”ç¤ºï¼Œæœ€ç»ˆå¯ä»¥è¯´æ˜ä¸‹ï¼Œå¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± çš„å®šä¹‰äº†ã€‚**

**å°ç»“ï¼š**

- å¸¸é‡æ± ï¼Œå°±æ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤é€šè¿‡è¿™å¼ è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åï¼Œæ–¹æ³•åï¼Œå‚æ•°ï¼Œå­—é¢é‡ç­‰ä¿¡æ¯ã€‚å­˜åœ¨äº.class å­—èŠ‚ç æ–‡ä»¶ä¸­ã€‚
- é‚£ä¹ˆè¿è¡Œæ—¶å¸¸é‡æ± å°±æ˜¯ï¼Œå½“è¯¥ç±»è¢«åŠ è½½ï¼Œé‚£ä¹ˆå¸¸é‡æ± ä¸­çš„æ•°æ®å°±ä¼šè¢«åŠ å…¥åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œå¹¶ä¸”é‡Œé¢çš„ç¬¦å·ä¼šå˜æˆçœŸå®çš„åœ°å€ã€‚ä¸åœ¨æ˜¯#2è¿™æ ·çš„ç¬¦å·äº†ã€‚



### StringTable(ä¸²æ± )

#### é¢è¯•é¢˜

å­¦ä¹ ä¸²æ± åï¼Œå°±ä¼šå¾ˆæ¸…æ¥šçš„çŸ¥é“ä¸‹é¢é—®é¢˜çš„ç»“æœï¼

```java
/**
 * JDK8 å­—ç¬¦ä¸²
 */
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "a" + "b";
        String s4 = s1 + s2;
        String s5 = "ab";
        String s6 = s4.intern();

        // é‚£ä¹ˆ?
        System.out.println(s3 == s4);
        System.out.println(s3 == s5);
        System.out.println(s3 == s6);

        // é‚£ä¹ˆ?
        String x2 = new String("c") + new String("d");
        String x1 = "cd";
        x2.intern();
        System.out.println(x1 == x2);
    }
}
```



<details>

  <summary>æŸ¥çœ‹ç»“æœï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>  

```java
System.out.println(s3 == s4); //false
System.out.println(s3 == s5); //true
System.out.println(s3 == s6); //true
System.out.println(x1 == x2); //false
```

</details>



#### è§£æï¼šè¿è¡Œæ—¶å¸¸é‡æ± å’Œä¸²æ± çš„å…³ç³»

é¦–å…ˆçœ‹ä¸‹ä¸€æ®µç®€å•çš„ä»£ç 

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
    }
}
```

åç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶åå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
âœ  example javap -v App 
è­¦å‘Š: äºŒè¿›åˆ¶æ–‡ä»¶AppåŒ…å«org.example.App
Classfile /Users/lichenghao/workspace/mtest/target/classes/org/example/App.class
  Last modified 2022-2-26; size 485 bytes
  MD5 checksum 4d10c3b4fba26b635a8d22881447c26c
  Compiled from "App.java"
public class org.example.App
  minor version: 0
  major version: 51
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #6.#24         // java/lang/Object."<init>":()V
   #2 = String             #25            // a
   #3 = String             #26            // b
   #4 = String             #27            // ab
   #5 = Class              #28            // org/example/App
   #6 = Class              #29            // java/lang/Object
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lorg/example/App;
  #14 = Utf8               main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8               args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8               s1
  #19 = Utf8               Ljava/lang/String;
  #20 = Utf8               s2
  #21 = Utf8               s3
  #22 = Utf8               SourceFile
  #23 = Utf8               App.java
  #24 = NameAndType        #7:#8          // "<init>":()V
  #25 = Utf8               a
  #26 = Utf8               b
  #27 = Utf8               ab
  #28 = Utf8               org/example/App
  #29 = Utf8               java/lang/Object
{
  public org.example.App();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 6: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/example/App;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=4, args_size=1
         0: ldc           #2                  // String a
         2: astore_1
         3: ldc           #3                  // String b
         5: astore_2
         6: ldc           #4                  // String ab
         8: astore_3
         9: return
      LineNumberTable:
        line 8: 0
        line 9: 3
        line 10: 6
        line 11: 9
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      10     0  args   [Ljava/lang/String;
            3       7     1    s1   Ljava/lang/String;
            6       4     2    s2   Ljava/lang/String;
            9       1     3    s3   Ljava/lang/String;
}
SourceFile: "App.java"

                                 
```

ä»è¿è¡Œæ—¶å¸¸é‡æ± ç« èŠ‚çŸ¥é“ï¼Œç±»è¢«åŠ è½½åï¼Œå¸¸é‡æ± ä¸­çš„ä¿¡æ¯ä¼šè¢«åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å¸¸é‡æ± ä¸­çš„ a b ab ä¼šè¢«åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œä½†æ˜¯è¿™æ—¶a b ab è¿˜æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„ç¬¦å·ï¼Œå¹¶æ²¡æœ‰å˜æˆå­—ç¬¦ä¸²å¯¹è±¡ï¼å½“æ‰§è¡Œåè™šæ‹ŸæœºæŒ‡ä»¤ï¼š

`0: ldc           #2                  // String a` è¿™æ—¶ä¼šæŠŠ aç¬¦å·å˜æˆ â€aâ€œå­—ç¬¦ä¸²å¯¹è±¡

`3: ldc           #3                  // String b` è¿™æ—¶ä¼šæŠŠ b ç¬¦å·å˜æˆâ€bâ€œå­—ç¬¦ä¸²å¯¹è±¡

`6: ldc           #4                  // String ab` è¿™æ—¶ä¼šæŠŠ ab ç¬¦å·å˜æˆâ€abâ€œå­—ç¬¦ä¸²å¯¹è±¡

ç„¶åå°†å­—ç¬¦ä¸²å¯¹è±¡æ”¾åˆ°StringTableï¼ˆä¸²æ± ï¼‰ä¸­ï¼Œæ‰€ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯â€æ‡’åŠ è½½çš„â€œï¼

 é‚£ä¹ˆå¯ä»¥å¾—å‡ºç»“è®ºï¼šs1 s2 s3 å¼•ç”¨çš„å­—ç¬¦ä¸²ï¼Œå…¨éƒ½åœ¨ä¸²æ± ä¸­ã€‚

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
    }
}
```



##### è§£æ s3==s4

é‚£ä¹ˆæˆ‘ä»¬åœ¨çœ‹ä¸‹ä¸‹é¢çš„ä»£ç ï¼šå¢åŠ äº† s4 çœ‹ä¸‹è™šæ‹Ÿæœºæ˜¯æ€ä¹ˆåšçš„ã€‚

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;
    }
}
```

åç¼–è¯‘å­—èŠ‚ç ï¼š

```java
Classfile /Users/lichenghao/workspace/mtest/target/classes/org/example/App.class
  Last modified 2022-2-26; size 669 bytes
  MD5 checksum 9a758cb7f7ea4c5c5b6d0101ded54cc0
  Compiled from "App.java"
public class org.example.App
  minor version: 0
  major version: 51
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #10.#29        // java/lang/Object."<init>":()V
   #2 = String             #30            // a
   #3 = String             #31            // b
   #4 = String             #32            // ab
   #5 = Class              #33            // java/lang/StringBuilder
   #6 = Methodref          #5.#29         // java/lang/StringBuilder."<init>":()V
   #7 = Methodref          #5.#34         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
   #8 = Methodref          #5.#35         // java/lang/StringBuilder.toString:()Ljava/lang/String;
   #9 = Class              #36            // org/example/App
  #10 = Class              #37            // java/lang/Object
  #11 = Utf8               <init>
  #12 = Utf8               ()V
  #13 = Utf8               Code
  #14 = Utf8               LineNumberTable
  #15 = Utf8               LocalVariableTable
  #16 = Utf8               this
  #17 = Utf8               Lorg/example/App;
  #18 = Utf8               main
  #19 = Utf8               ([Ljava/lang/String;)V
  #20 = Utf8               args
  #21 = Utf8               [Ljava/lang/String;
  #22 = Utf8               s1
  #23 = Utf8               Ljava/lang/String;
  #24 = Utf8               s2
  #25 = Utf8               s3
  #26 = Utf8               s4
  #27 = Utf8               SourceFile
  #28 = Utf8               App.java
  #29 = NameAndType        #11:#12        // "<init>":()V
  #30 = Utf8               a
  #31 = Utf8               b
  #32 = Utf8               ab
  #33 = Utf8               java/lang/StringBuilder
  #34 = NameAndType        #38:#39        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
  #35 = NameAndType        #40:#41        // toString:()Ljava/lang/String;
  #36 = Utf8               org/example/App
  #37 = Utf8               java/lang/Object
  #38 = Utf8               append
  #39 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;
  #40 = Utf8               toString
  #41 = Utf8               ()Ljava/lang/String;
{
  public org.example.App();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 6: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/example/App;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=5, args_size=1
         0: ldc           #2                  // String a
         2: astore_1
         3: ldc           #3                  // String b
         5: astore_2
         6: ldc           #4                  // String ab
         8: astore_3
         9: new           #5                  // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6                  // Method java/lang/StringBuilder."<init>":()V
        16: aload_1
        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
        29: return
      LineNumberTable:
        line 8: 0
        line 9: 3
        line 10: 6
        line 11: 9
        line 12: 29
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      30     0  args   [Ljava/lang/String;
            3      27     1    s1   Ljava/lang/String;
            6      24     2    s2   Ljava/lang/String;
            9      21     3    s3   Ljava/lang/String;
           29       1     4    s4   Ljava/lang/String;
}
SourceFile: "App.java"
```

é€šè¿‡è™šæ‹ŸæœºæŒ‡ä»¤å¯ä»¥çœ‹å‡ºï¼šs1 å’Œ s2 çš„æ‹¼æ¥æ˜¯é€šè¿‡StringBuilderæ¥å®Œæˆçš„ï¼Œæœ€åè°ƒç”¨äº†StringBuilder.toStringæ–¹æ³•ç”Ÿæˆäº† s4.

```java
         9: new           #5                  // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6                  // Method java/lang/StringBuilder."<init>":()V
        16: aload_1
        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
```

åœ¨çœ‹ä¸‹ StringBuilderçš„toString()æ–¹æ³•ï¼šçœ‹åˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ `new` å…³é”®å­—

```java
@Override
    public String toString() {
        // Create a copy, don't share the array
        return new String(value, 0, count);
    }
```

é‚£ä¹ˆå°±å¯ä»¥å¾—å‡ºç»“è®ºäº†ï¼š

s4 è‚¯å®šæ˜¯ä¸æ˜¯ä¸²æ± ä¸­çš„å¯¹è±¡äº†ï¼Œå› ä¸ºå®ƒæ˜¯ new å‡ºæ¥çš„ã€‚

æ‰€ä»¥ï¼š

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;

        //false å› ä¸ºs3æ˜¯ä¸²æ± ä¸­çš„å¯¹è±¡ï¼Œs4åœ¨å †ä¸Š
        System.out.println(s3 == s4);
    }
}
```



##### è§£æ s3==s5

å¦‚ä¸‹ä»£ç ç¿»è¯‘å­—èŠ‚ç åï¼š

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;
        String s5 = "a" + "b";
    }
}
```

çœç•¥äº†éƒ¨åˆ†ï¼Œç›´æ¥çœ‹ main æ–¹æ³•çš„è™šæ‹ŸæœºæŒ‡ä»¤ï¼š

```java
 public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=6, args_size=1
         0: ldc           #2                  // String a
         2: astore_1
         3: ldc           #3                  // String b
         5: astore_2
         6: ldc           #4                  // String ab
         8: astore_3
         9: new           #5                  // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6                  // Method java/lang/StringBuilder."<init>":()V
        16: aload_1
        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
        29: ldc           #4                  // String ab
        31: astore        5
        33: return

```



` 29: ldc           #4                  // String ab`  å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„ s5 å˜é‡ç›´æ¥è¿”å›äº†å¸¸é‡æ± ä¸­çš„ ab å­—ç¬¦ä¸²ï¼Œè¿™é‡Œç®—æ˜¯ä¸ªä¼˜åŒ–æŠŠï¼Œå› ä¸ºæˆ‘ä»¬çš„ s3 å·²ç»å®šä¹‰å¥½äº†ab , s5 æŠŠ a å’Œ  b æ‹¼æ¥èµ·æ¥ç»“æœè‚¯å®šä¹Ÿæ˜¯ ab æ‰€ä»¥å°±ç›´æ¥ç”¨äº†å·²ç»å®šä¹‰å¥½çš„ã€‚

æ‰€ä»¥ï¼š

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;
        String s5 = "a" + "b";
        // true å› ä¸º s3å’Œs5 å¼•ç”¨çš„éƒ½æ˜¯ä¸²æ± ä¸­çš„å¯¹è±¡
        System.out.println(s3 == s5);
    }
}
```



##### è§£æ s3==s6

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;
        String s5 = "a" + "b";
        String s6 = s4.intern();
    }
}
```

å…ˆçœ‹ä¸‹å¦‚ä¸‹çš„ğŸŒ°ï¼š

è¿™é‡Œè°ƒç”¨äº†`intern`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨ï¼šä¸»åŠ¨å°†ä¸²æ± ä¸­æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾åˆ°ä¸²æ± ä¸­ã€‚

```java
// æŒ‰ç…§å¦‚ä¸‹æ–¹å¼åˆ›å»ºé‚£ä¹ˆï¼Œå †ä¸­ä¼šäº§ç”Ÿä¸‰ä¸ªå¯¹è±¡ï¼Œx y xy
String str = new String("x") + new String("y");
```

ç„¶åè°ƒç”¨internæ–¹æ³•ï¼Œå°† str å¼•ç”¨çš„å¯¹è±¡æ”¾åˆ°ä¸²æ± ä¸­ï¼š

```java
 String str2 = str.intern();
```

å¦‚æœä¸²æ± ä¸­æœ‰è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›ä¸²æ± ä¸­çš„å¯¹è±¡ï¼›å¦‚æœæ²¡æœ‰å°†è¯¥å¯¹è±¡æ”¾åˆ°ä¸²æ± ä¸­ï¼Œè¿”å›ä¸²æ± ä¸­çš„è¯¥å¯¹è±¡ã€‚`ï¼ˆè¿™éœ€è¦æ³¨æ„ï¼šå¦‚æœæœ‰çš„è¯è¿”å›çš„å¯¹è±¡æ˜¯ä¸²æ± ä¸­çš„ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å…¶å®å°±æ˜¯æŠŠè‡ªå·±æ”¾è¿›å»äº†ï¼Œè¿”å›è‡ªå·±çš„åœ°å€ï¼‰ã€‚`

é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼š

```java
// stråŠ å…¥ä¸²æ± ï¼Œè¿”å›çš„å¼•ç”¨å…¶å®å°±æ˜¯ strï¼Œä¹Ÿå³æ˜¯æŠŠ xy åŠ å…¥ä¸²æ± äº†
// æ‰€ä»¥ str2 å’Œ â€xyâ€œ éƒ½æ˜¯ä¸²æ± ä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥ true
System.out.println(str2 == "xy");
// true
System.out.println(str == str2);
```

æ‰€ä»¥ï¼š

æˆ‘ä»¬ s4å…¥æ± åï¼Œå› ä¸º abå·²ç»åœ¨ä¸²æ± ä¸­äº†ï¼Œæ‰€ä»¥ s6å¼•ç”¨çš„ä¸²æ± ä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥ s3 å’Œ s6 å¼•ç”¨éƒ½æ˜¯ä¸²æ± ä¸­çš„å¯¹è±¡ã€‚

```java
public class App {
    public static void main(String[] args) {
        String s1 = "a";
        String s2 = "b";
        String s3 = "ab";
        String s4 = s1 + s2;
        String s5 = "a" + "b";
        String s6 = s4.intern();

        //true s4å…¥æ± ï¼Œæ± ä¸­å·²ç»æœ‰ ab é‚£ä¹ˆç›´æ¥è¿”å›æ± ä¸­çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå’Œ s3ä¸€æ ·ï¼Œéƒ½æ˜¯æ± ä¸­çš„å¯¹è±¡
        System.out.println(s3==s6);
    }
}
```



##### è§£æ x1==x2

æœ‰äº†ä¸Šé¢internçš„è§£æé‚£ä¹ˆä¸‹é¢çš„å°±å¾ˆå®¹æ˜“äº†ã€‚

```java
public class App {
    public static void main(String[] args) {
        // é‚£ä¹ˆ?
        String x2 = new String("c") + new String("d");
        String x1 = "cd";
        x2.intern();
        //false x2æ˜¯å †ä¸­çš„ï¼Œx1 æ˜¯ä¸²æ± ä¸­çš„
        System.out.println(x1 == x2);
    }
}
```

å¦‚æœè°ƒæ¢ä¸‹æœ€åä¸¤è¡Œçš„ä»£ç çš„ä½ç½®ï¼š

```java
public class App {
    public static void main(String[] args) {
        // é‚£ä¹ˆ?
        String x2 = new String("c") + new String("d");
        x2.intern();
        String x1 = "cd";
        //true x2 å…¥æ± ï¼Œæ± ä¸­æ²¡æœ‰cdï¼Œé‚£ä¹ˆæˆåŠŸå°†x2å¼•ç”¨çš„cdå…¥æ± ï¼Œx1å–å¸¸é‡æ± çš„cdå…¶å®å°±æ˜¯å–åˆ°äº†x2å¼•ç”¨çš„cd 
        //ç´¢å¼• x1==x2
        System.out.println(x1 == x2);
    }
}
```



#### StringTable ä½ç½®

åœ¨ JDK1.8ä¸­ä¸²æ± æ”¾åˆ°å †ä¸­äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://blog.lichenghao.cn/upload/2022/07/090818-jvm.png)

StringTable ç”¨å­—ç¬¦ä¸²éå¸¸é¢‘ç¹ï¼Œæ‰€ä»¥å°†å®ƒè½¬ç§»åˆ°å †ä¸­ï¼Œå› ä¸ºå †ä¸­çš„åƒåœ¾å›æ”¶æ•ˆç‡æ˜¯å¾ˆé«˜çš„ã€‚

éªŒè¯å®ƒçš„ä½ç½®ä¹Ÿéå¸¸ç®€å•ï¼Œç–¯ç‹‚çš„å‘ä¸²æ± ä¸­æ·»åŠ å­—ç¬¦ä¸²ï¼Œç„¶å OOM çœ‹å“ªé‡ŒæŠ¥é”™å°±çŸ¥é“å­˜åœ¨ä½ç½®äº†ã€‚



<!-- panels:start -->
<!-- div:title-panel -->

  æ¼”ç¤ºä¸²æ± çš„ä½ç½®

<!-- div:left-panel -->

  ```java
  /**
   * æ¼”ç¤ºä¸²æ± çš„ä½ç½®
   * VMå‚æ•°ï¼š-Xmx10m -XX:-UseGCOverheadLimit
   */
  public class App {
      public static void main(String[] args) {
          List<String> list = new ArrayList<>();
          try {
              for (int i = 0; i < 1000000; i++) {
                  list.add(String.valueOf(i).intern());
              }
          } catch (Throwable e) {
              e.printStackTrace();
          }
      }
  }
  ```

<!-- div:right-panel -->

ç»“æœï¼š

  ```java
  java.lang.OutOfMemoryError: Java heap space
  	at java.lang.Integer.toString(Integer.java:403)
  	at java.lang.String.valueOf(String.java:3099)
  	at org.example.App.main(App.java:15)
  ```

<!-- panels:end -->



#### åƒåœ¾å›æ”¶â™»ï¸

ä¸²æ± ä¹Ÿä¼šå‘ç”Ÿåƒåœ¾å›æ”¶ã€‚

ä¸å†™ä»»ä½•ä»£ç ï¼Œçœ‹ä¸‹ä¸²æ± çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```java
package org.example;

/**
 * æ¼”ç¤ºä¸²æ± çš„åƒåœ¾å›æ”¶
 * VMå‚æ•°ï¼š-Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc
 */
public class App {
    public static void main(String[] args) {
      
    }
}
```

é€šè¿‡ JVMå‚æ•°æŸ¥çœ‹ä¸²æ± çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```java
Heap
 PSYoungGen      total 2560K, used 1360K [0x00000007bfd00000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 2048K, 66% used [0x00000007bfd00000,0x00000007bfe54328,0x00000007bff00000)
  from space 512K, 0% used [0x00000007bff80000,0x00000007bff80000,0x00000007c0000000)
  to   space 512K, 0% used [0x00000007bff00000,0x00000007bff00000,0x00000007bff80000)
 ParOldGen       total 7168K, used 0K [0x00000007bf600000, 0x00000007bfd00000, 0x00000007bfd00000)
  object space 7168K, 0% used [0x00000007bf600000,0x00000007bf600000,0x00000007bfd00000)
 Metaspace       used 2962K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 323K, capacity 388K, committed 512K, reserved 1048576K
SymbolTable statistics:
Number of buckets       :     20011 =    160088 bytes, avg   8.000
Number of entries       :     11899 =    285576 bytes, avg  24.000
Number of literals      :     11899 =    460432 bytes, avg  38.695
Total footprint         :           =    906096 bytes
Average bucket size     :     0.595
Variance of bucket size :     0.597
Std. dev. of bucket size:     0.773
Maximum bucket size     :         6
StringTable statistics:   // ä¸²æ± çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œç»“æ„hashè¡¨
Number of buckets       :     60013 =    480104 bytes, avg   8.000   // é»˜è®¤è¿™ä¹ˆå¤šçš„æ¡¶
Number of entries       :       838 =     20112 bytes, avg  24.000   // å·²ç»æœ‰è¿™ä¹ˆå¤šæ•°æ®äº†
Number of literals      :       838 =     56792 bytes, avg  67.771
Total footprint         :           =    557008 bytes
Average bucket size     :     0.014
Variance of bucket size :     0.014
Std. dev. of bucket size:     0.118
Maximum bucket size     :         2

Process finished with exit code 0

```

ç„¶åæˆ‘ä»¬å‘ä¸²æ± ä¸­æ”¾å­—ç¬¦ä¸²ï¼Œä¼šå‘ç°è¿™é‡Œä¼šå‘ç”Ÿ GC:

```java
/**
 * æ¼”ç¤ºä¸²æ± çš„åƒåœ¾å›æ”¶
 * VMå‚æ•°ï¼š-Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc
 */
public class App {
    public static void main(String[] args) {
        try {
            for (int i = 0; i < 20000; i++) {
                String.valueOf(i).intern();
            }
        } catch (Throwable e) {
            e.printStackTrace();
        }
    }
}
```

ç»“æœï¼šGCäº†

```java
[GC (Allocation Failure) [PSYoungGen: 2048K->512K(2560K)] 2048K->528K(9728K), 0.0024245 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
Heap
 PSYoungGen      total 2560K, used 889K [0x00000007bfd00000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 2048K, 18% used [0x00000007bfd00000,0x00000007bfd5e620,0x00000007bff00000)
  from space 512K, 100% used [0x00000007bff00000,0x00000007bff80000,0x00000007bff80000)
  to   space 512K, 0% used [0x00000007bff80000,0x00000007bff80000,0x00000007c0000000)
 ParOldGen       total 7168K, used 16K [0x00000007bf600000, 0x00000007bfd00000, 0x00000007bfd00000)
  object space 7168K, 0% used [0x00000007bf600000,0x00000007bf604000,0x00000007bfd00000)
 Metaspace       used 3110K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 340K, capacity 388K, committed 512K, reserved 1048576K
SymbolTable statistics:
Number of buckets       :     20011 =    160088 bytes, avg   8.000
Number of entries       :     12255 =    294120 bytes, avg  24.000
Number of literals      :     12255 =    472232 bytes, avg  38.534
Total footprint         :           =    926440 bytes
Average bucket size     :     0.612
Variance of bucket size :     0.615
Std. dev. of bucket size:     0.784
Maximum bucket size     :         6
StringTable statistics:
Number of buckets       :     60013 =    480104 bytes, avg   8.000
Number of entries       :      6497 =    155928 bytes, avg  24.000  // æœ€ç»ˆç•™ä¸‹è¿™ä¹ˆå¤šçš„å­—ç¬¦ä¸²
Number of literals      :      6497 =    374176 bytes, avg  57.592
Total footprint         :           =   1010208 bytes
Average bucket size     :     0.108
Variance of bucket size :     0.113
Std. dev. of bucket size:     0.335
Maximum bucket size     :         3
```



#### è°ƒä¼˜ï¼Œè°ƒæ•´æ¡¶ï¼Œå…¥æ± 

**è°ƒæ•´æ¡¶**

ä¸²æ± æ˜¯ hash è¡¨ç»“æ„ï¼Œå¦‚æœæ¡¶ä¸ªæ•°å°‘çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿ hash å†²çªã€‚å¯ä»¥é€šè¿‡JVM å‚æ•°æŒ‡å®šä¸²æ± ä¸­çš„æ¡¶çš„ä¸ªæ•°ã€‚

`-XX:StringTableSize=num`

```java
package org.example;

/**
 * æ¼”ç¤ºè®¾ç½®ä¸²æ± æ¡¶
 * VMå‚æ•°ï¼š-XX:StringTableSize=50000 -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc
 */
public class App {
    public static void main(String[] args) {
        try {
            for (int i = 0; i < 20000; i++) {
                String.valueOf(i).intern();
            }
        } catch (Throwable e) {
            e.printStackTrace();
        }
    }
}
```

```java
....
StringTable statistics:
Number of buckets       :     50000 =    400000 bytes, avg   8.000
Number of entries       :     20890 =    501360 bytes, avg  24.000
Number of literals      :     20890 =   1100560 bytes, avg  52.684
Total footprint         :           =   2001920 bytes
......
```



**å­—ç¬¦ä¸²å¯¹è±¡å…¥æ± **

é™¤äº†è°ƒæ•´ä¸²æ± ä¸­çš„æ¡¶çš„å¤§å°ä»¥å¤–ï¼Œæˆ‘ä»¬ä¼šé¢‘ç¹çš„åœ¨å †ä¸­ new å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘å°†å­—ç¬¦ä¸²å…¥æ± ï¼Œè¿™æ ·çš„è¯å¯ä»¥å®ç°å­—ç¬¦ä¸²çš„å¤ç”¨ä¹Ÿå¯ä»¥èµ·åˆ°è°ƒä¼˜çš„æ•ˆæœã€‚



## ç›´æ¥å†…å­˜

### å®šä¹‰

Direct Memoryï¼Œå±äºç³»ç»Ÿå†…å­˜ï¼š

- å¸¸è§äº NIO æ“ä½œï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº
- åˆ†é…æˆæœ¬è¾ƒé«˜ï¼Œä½†æ˜¯è¯»å†™æ€§èƒ½é«˜
- ä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†



é€šè¿‡ä¸€ä¸ªæ‹·è´æ“ä½œï¼Œæ¼”ç¤ºä¼ ç»Ÿçš„ IO å’Œ NIO å¯¹æ¯”ï¼Œå¯ä»¥çœ‹å‡ºç›´æ¥å†…å­˜çš„è¯»å†™æ€§èƒ½ã€‚

```java
/**
 * æ¼”ç¤º IO å’Œ NIO æ‹·è´
 */
public class App {
    private static final String SRC_PATH = "/Users/lichenghao/workspace/test/test.iso";
    private static final String DST_PATH = "/Users/lichenghao/workspace/test/copy/test.iso";

    public static void main(String[] args) {
        IO();
        DirectBuf();
    }

    private static void IO() {
        long start = System.nanoTime();
        FileInputStream in = null;
        FileOutputStream out = null;
        try {
            in = new FileInputStream(SRC_PATH);
            out = new FileOutputStream(DST_PATH);
            byte[] buf = new byte[1024 * 1024];
            while (true) {
                int len = in.read(buf);
                if (len == -1) {
                    break;
                }
                out.write(buf, 0, len);
            }
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (in != null) {
                try {
                    in.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (out != null) {
                try {
                    out.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        long cost = System.nanoTime() - start;
        System.out.println("cost:" + TimeUnit.SECONDS.convert(cost, TimeUnit.NANOSECONDS));
    }

    private static void DirectBuf() {
        long start = System.nanoTime();
        FileChannel in = null;
        FileChannel out = null;
        try {
            in = new FileInputStream(SRC_PATH).getChannel();
            out = new FileOutputStream(DST_PATH).getChannel();
            ByteBuffer allocate = ByteBuffer.allocateDirect(1024 * 1024);
            while (true) {
                int read = in.read(allocate);
                if (read == -1) {
                    break;
                }
                allocate.flip();
                out.write(allocate);
                allocate.clear();
            }
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (in != null) {
                try {
                    in.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (out != null) {
                try {
                    out.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        long cost = System.nanoTime() - start;
        System.out.println("cost:" + TimeUnit.SECONDS.convert(cost, TimeUnit.NANOSECONDS));
    }
}
```



### å†…å­˜æº¢å‡º

æ—¢ç„¶ç›´æ¥å†…å­˜ä¸æ”¶ JVM çš„ç®¡ç†ï¼Œé‚£ä¹ˆè‚¯å®šä¼šå†…å­˜æº¢å‡ºäº†ã€‚å¦‚ä¸‹ï¼š

```java
/**
 * æ¼”ç¤ºç›´æ¥å†…å­˜æº¢å‡º
 */
public class App {
    public static void main(String[] args) {
        List<ByteBuffer> list = new ArrayList<>();
        int sum = 0;
        try {
            while (true) {
              	// 100M
                ByteBuffer byteBuffer = ByteBuffer.allocateDirect(1024 * 1024 * 100);
                list.add(byteBuffer);
                sum++;
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println(sum);
        }
    }
}
```

ç»“æœï¼š

```java
36
Exception in thread "main" java.lang.OutOfMemoryError: Direct buffer memory
	at java.nio.Bits.reserveMemory(Bits.java:695)
	at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:123)
	at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)
	at org.example.App.main(App.java:16)
```



### å†…å­˜ç”³è¯·é‡Šæ”¾åŸç†

è¿™å—å†…å­˜è‚¯å®šæ˜¯å¯ç®¡ç†çš„ï¼Œä¸ç„¶ä¸å¾—æ¯æ¬¡éƒ½å¾—å†…å­˜æº¢å‡ºï¼Œé‚£ä¹ˆç›´æ¥å†…å­˜æ˜¯å¦‚ä½•ç”³è¯·å’Œé‡Šæ”¾çš„å‘¢ï¼Ÿ

è¿è¡Œå¦‚ä¸‹ç¨‹åºï¼ŒæŸ¥çœ‹ç³»ç»Ÿå†…å­˜çš„å ç”¨ï¼š

```java
/**
 * æ¼”ç¤ºç›´æ¥
 */
public class App {
    public static void main(String[] args) throws IOException {
        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(1024 * 1024 * 1024);
        System.out.println("ç”³è¯·ç›´æ¥å†…å­˜å®Œæ¯•");
        System.in.read();
        System.out.println("é‡Šæ”¾ç›´æ¥å†…å­˜");
        byteBuffer = null;
        System.gc();
        System.in.read();
    }
}
```

ç¨‹åºè¿è¡Œå‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ´»åŠ¨ç›‘æ§å™¨çš„å†…å­˜æƒ…å†µï¼ˆwin ä¸‹ä»»åŠ¡ç®¡ç†å™¨ï¼‰

![](https://blog.lichenghao.cn/upload/2022/07/4094552-jvm.png)

å½“ç¨‹åºè¿è¡Œï¼Œåˆ°ç¬¬ä¸€æ¬¡åœæ­¢çš„æ—¶å€™ï¼Œæ‰“å° â€œç”³è¯·ç›´æ¥å†…å­˜å®Œæ¯•â€ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹æ´»åŠ¨ç›‘æ§å™¨,å¾ˆæ˜æ˜¾å¤šäº†ä¸€ä¸ªg çš„å†…å­˜å ç”¨ï¼›

![](https://blog.lichenghao.cn/upload/2022/07/4094620-jvm.png)

å½“ç¨‹åºæ‰§è¡Œå®Œæ¯•åï¼Œæ‰§è¡Œäº†åƒåœ¾å›æ”¶â™»ï¸ï¼Œå‘ç°è¿™å—çš„ç›´æ¥å†…å­˜ä¹Ÿé‡Šæ”¾æ‰äº†

![](https://blog.lichenghao.cn/upload/2022/07/4094641-jvm.png)



å¾ˆæ˜æ˜¾ï¼Œæ‰§è¡Œäº†åƒåœ¾å›æ”¶åï¼Œç›´æ¥å†…å­˜ä¹Ÿé‡Šæ”¾äº†ï¼Œéš¾é“å— JVM ç®¡ç†äº†ï¼Ÿ

è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒåº•å±‚çš„ç±»`Unsafe`, é€šå¸¸è¿™ä¸ªç±»åœ¨ JDK å†…éƒ¨ä½¿ç”¨ï¼Œå®ƒå¯ä»¥ç”³è¯·å’Œé‡Šæ”¾ç³»ç»Ÿå†…å­˜,é€šè¿‡æ–¹æ³•`public native long allocateMemory(long var1);`å’Œ`public native void freeMemory(long var1);` 

 ByteBuffer ä¹Ÿæ˜¯åˆ©ç”¨äº†è¿™ä¸ªç±»å¯¹ç›´æ¥å†…å­˜çš„ä½¿ç”¨ã€‚å¦‚ä¸‹ç”³è¯·ç›´æ¥å†…å­˜çš„æ–¹æ³•ã€‚

```java
 public static ByteBuffer allocateDirect(int capacity) {
        return new DirectByteBuffer(capacity);
    }
```

â†“  `unsafe.setMemory(base, size, (byte) 0);` ç”³è¯·äº†å†…å­˜

```java
DirectByteBuffer(int cap) {                   // package-private

        super(-1, 0, cap, cap);
        boolean pa = VM.isDirectMemoryPageAligned();
        int ps = Bits.pageSize();
        long size = Math.max(1L, (long)cap + (pa ? ps : 0));
        Bits.reserveMemory(size, cap);

        long base = 0;
        try {
            base = unsafe.allocateMemory(size);
        } catch (OutOfMemoryError x) {
            Bits.unreserveMemory(size, cap);
            throw x;
        }
        unsafe.setMemory(base, size, (byte) 0);
        if (pa && (base % ps != 0)) {
            // Round up to page boundary
            address = base + ps - (base & (ps - 1));
        } else {
            address = base;
        }
        cleaner = Cleaner.create(this, new Deallocator(base, size, cap));
        att = null;
    }
```



ç›´æ¥å†…å­˜çš„æ¸…ç†ï¼Œæ˜¯é€šè¿‡`cleaner = Cleaner.create(this, new Deallocator(base, size, cap));` ä¹Ÿå°±æ˜¯Cleaner æä¾›çš„æ¸…ç†æ–¹æ³•ã€‚å¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯ä¸ªè™šå¼•ç”¨å¯¹è±¡ã€‚

```java
public class Cleaner extends PhantomReference<Object> {
  .....
}
```

å½“å®ƒæ‰€å…³è”çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶äº†ï¼Œé‚£ä¹ˆ Clanner å°±ä¼šé€šè¿‡ clean()æ–¹æ³•æ‰§è¡ŒDeallocator è¿™ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡ä¸­å°±ä¼šé‡Šæ”¾ç›´æ¥å†…å­˜ï¼›

å¦‚ä¸‹çš„ `unsafe.freeMemory(address);`

```java
 private static class Deallocator  implements Runnable
    {

        private static Unsafe unsafe = Unsafe.getUnsafe();

        private long address;
        private long size;
        private int capacity;

        private Deallocator(long address, long size, int capacity) {
            assert (address != 0);
            this.address = address;
            this.size = size;
            this.capacity = capacity;
        }

        public void run() {
            if (address == 0) {
                // Paranoia
                return;
            }
            unsafe.freeMemory(address);
            address = 0;
            Bits.unreserveMemory(size, capacity);
        }

    }
```

### å°ç»“

- ç›´æ¥å†…å­˜çš„ä½¿ç”¨éœ€è¦ä¾èµ–`Unsafe`è€Œä¸”é‡Šæ”¾`å¿…é¡»é€šè¿‡freeMemory`æ–¹æ³•
- ByteBuffer å†…éƒ¨ä½¿ç”¨è™šå¼•ç”¨å¯¹è±¡ Cleanerï¼Œä¸€æ—¦ByteBuffer å¯¹è±¡è¢«å›æ”¶ï¼Œè™šå¼•ç”¨å¯¹è±¡å°±ä¼šæ”¾åˆ°å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œå¼•ç”¨é˜Ÿåˆ—çš„å®ˆæŠ¤çº¿ç¨‹å°±ä¼šè°ƒç”¨è™šå¼•ç”¨å¯¹è±¡Cleanerçš„clean() é‡Šæ”¾å¯¹åº”çš„ç›´æ¥å†…å­˜ï¼Œæ˜¯ä¾é äº†è™šå¼•ç”¨å’Œè™šå¼•ç”¨é˜Ÿåˆ—çš„æœºåˆ¶ã€‚

























